<html>

	<head>
		<script type="text/javascript" src="libraries/d3.min.js"></script> 
<!--		<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>-->
		<!-- include the path to the leaflet.js library -->
		<script type="text/javascript" src="libraries/leaflet.js"></script>
		
		<!-- include external stylesheet for leaflet -->
		<link rel="stylesheet" href="libraries/leaflet.css"/>
		
        <link href="https://fonts.googleapis.com/css?family=Orbitron" rel="stylesheet">
		<!-- define width and height of the div with the name/id "map" -->
		<!-- the # indicates that "map" is an id -->
		<style>
            #content {
                display: block;
                margin-left: auto;
                margin-right: auto;
                width: 95%;
                text-align: center;
            }
            
            #title {
                margin-left: auto;
                margin-right: auto;
                text-align: center;
                font-size: 2em;
            }
            
			#map{
				width: 50%;
				height: 90%;
                margin-left: auto;
                margin-right: auto;
			}
            
            
            body {
                font-family: 'Orbitron', sans-serif;
                background-color: black;
                color: white;
                align-content: center;
            }
            
            #controls {
                text-align: center;
                margin-left: auto;
                margin-right: auto;
            }
            
            .buttons {
                font-family: 'Orbitron', sans-serif;
                background-color: black;
                color: white;
                display: inline;
                margin-left: auto;
                margin-right: auto;
                font-size: 2em;
            }
            
            #sightings {
                text-align: center;
                font-family: 'Orbitron', sans-serif;
                background-color: black;
                color: white;
                display: inline;
                margin-left: auto;
                margin-right: auto;
                font-size: 1.2em;
            }
            
            
            /* Portrait and Landscape */
        @media only screen 
          and (min-device-width: 375px) 
          and (max-device-width: 667px) 
          and (-webkit-min-device-pixel-ratio: 2) { 
              
            #map {
                  width: 90%;
                  height: 90%;
            }

        }
            
            .bar {fill: steelblue;}
		</style>
		
		
        <title>D3 UFO sighting map</title>
	</head>

    
	<body>
        <!-- TITLE -->
		<h2 id="title">UFO Sighting Map</h2>
        <div id="content">
            
            <!-- CONTROLS -->
            <div id="controls">
                <div class="buttons" onclick="minusYear()">-</div>
                <p class="buttons" id="year"></p>
                <div class="buttons" onclick="addYear()">+</div>
            </div>
            
            <!-- INFORMATION -->
            <p class="sightings" id="sightings"></p>

            <!-- BAR CHART -->
            <div  id="bar-chart"></div>
            
            <!-- MAP -->
            <div id="map">				
            </div>
		</div>
		<script>
			
    //INITIAL PAGE SETUP: HAPPENS ON LOAD -------------------------------------------------------
			
            var dataPath = "ufo-sightings/complete.csv";
            
            
            // set the dimensions and margins of the graph
            var margin = {top: 20, right: 20, bottom: 30, left: 40},
                width = 960 - margin.left - margin.right,
                height = 500 - margin.top - margin.bottom;

            // set the ranges
            var x = d3.scaleBand()
                      .range([0, width])
                      .padding(0.1);
            var y = d3.scaleLinear()
                      .range([height, 0]);

            // append the svg object to the body of the page
            // append a 'group' element to 'svg'
            // moves the 'group' element to the top left margin
            var svg = d3.select("#bar-chart").append("svg")
                .attr("width", width + margin.left + margin.right)
                .attr("height", height + margin.top + margin.bottom)
              .append("g")
                .attr("transform", 
                      "translate(" + margin.left + "," + margin.top + ")");

            
            //BAR CHART
            d3.csv(dataPath, function(error, data){
                var myData = data;
                console.log(data);
                var myDataByYear = [];
                
            //calculate number of occurrences per year in the UK
                //for each year in the dataset for the UK (1955-2014), count how many sightings occur
                for (var year = 1955; year < 2015; year++){
                    let sightingCount = 0;
                    myData.forEach(function(d){
                        if (d.country == "gb" && d.datetime.substr(6, 4) == year){
                            sightingCount++;
                        }
                    })
                    //put that into an object and that object into an array
                    var yearObject = {
                        year: year,
                        sightingCount: sightingCount
                        }
                    myDataByYear.push(yearObject);
                }
                //show the complete array of data by year
                console.log(myDataByYear);
                
                //now visualise the data
                  // Scale the range of the data in the domains
                  x.domain(data.map(function(d) { return d.year; }));
                  y.domain([0, d3.max(data, function(d) { return d.sightingCount; })]);

                  // append the rectangles for the bar chart
                  svg.selectAll(".bar")
                      .data(myDataByYear)
                    .enter().append("rect")
                      .attr("class", "bar")
                      .attr("x", function(d) { return x(d.year); })
                      .attr("width", x.bandwidth())
                      .attr("y", function(d) { return y(d.sightingCount); })
                      .attr("height", function(d) { return height - y(d.sightingCount); });

                  // add the x Axis
                  svg.append("g")
                      .attr("transform", "translate(0," + height + ")")
                      .call(d3.axisBottom(x));

                  // add the y Axis
                  svg.append("g")
                      .call(d3.axisLeft(y));

                });

//
//            d3.select('#bar-chart').append('svg')
//              .attr('width', width)
//              .attr('height', height)
//              .style('background', '#dff0d8')
//              .selectAll('rect').data(myDatabyYear)
//              .enter().append('rect')
//                .style({'fill': '#3c763d', 'stroke': '#d6e9c6', 'stroke-width': '5'})
//                .attr('width', barWidth)
//                .attr('height', function (d) {
//                    return d.sightingCount;
//                })
//                .attr('x', function (d, i) {
//                    return i * (barWidth + barOffset);
//                })
//                .attr('y', function (d) {
//                    return height - d.sightingCount;
//                });
//
//
//            d3.select('#bar-chart').append('svg')
//              .attr('width', width)
//              .attr('height', height)
//              .style('background', '#dff0d8')
//              .selectAll('rect').data(chartdata)
//              .enter().append('rect')
//                .style({'fill': '#3c763d', 'stroke': '#d6e9c6', 'stroke-width': '5'})
//                .attr('width', barWidth)
//                .attr('height', function (data) {
//                    return data;
//                })
//                .attr('x', function (data, i) {
//                    return i * (barWidth + barOffset);
//                })
//                .attr('y', function (data) {
//                    return height - data;
//                });
//            });
            


  
                
            //MAP
            //add open street map element to div
			var map = L.map('map').setView([55.9531, -3.1889], 5);			// the first array includes the latitude and longitude in the centre
																			//the integer value (11) indicates the zoom level
			
			L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png',{
				attribution: '&copy; <a href="href://osm.org/copyright">OpenStreetMap</a> contributors'
				}).addTo(map);
            
            
            var myIcon = L.icon({
                iconUrl: 'images/ufo.png',
                iconSize: [30, 30],
                iconAnchor: [0, 30],
                popupAnchor: [0, 20],
            });

            
//            var dataPath = "edinburghLocations.csv";
            
            //on load, place markers for all UK-based sightings in the year 2000
            var year = 2000;
            var sightings = 0;
            var currentLayer;
            
            //make a new layer group
            var markersLayer = new L.LayerGroup();
            
            //fill the layer with UFO elements for each UK-based UFO sighting
            d3.csv(dataPath, function(error, data){
                var myData = data;
                console.log(data);
                var marker;
                var myDataParsed = [];
                
            //parse the data by the filter category
                myData.forEach(function(d){
                    if (d.country == "gb" && d.datetime.substr(6, 4) == year){
                        sightings+=1;
                        myDataParsed.push(d);
                    }
                });
                
                console.log(myDataParsed);
                
            //update the sightings count
                displaySightings();
                
            //place markers for all filtered data elements using UFO icon
                myDataParsed.forEach(function(d){
                    var markerText = "City" + d.city;
                    marker = L.marker([d.latitude, d.longitude], {icon: myIcon}).addTo(map)
                    .bindTooltip("<b>City: </b>"  + d.city.substring(0, d.city.indexOf("("))  + "<br><b>Type: </b>" + d.shape);
                    currentLayer = L.marker([d.latitude, d.longitude], {icon: myIcon});
                    markersLayer.addLayer(marker); 
                    markersLayer.addTo(map);
                })
            });
                
            
    //SUPPORTING FUNCTIONS -------------------------------------------------------------------
            
            function reload() {
                //reset data and display layers
                console.log("changing year to " + year);
                sightings = 0;
                markersLayer.remove();
                markersLayer.clearLayers();
                myDataParsed = [];
                
                d3.csv(dataPath, function(error, data){
                    var myData = data;
                    console.log(data);
                    var myDataParsed = [];
                //parse the data by the filter category
                    myData.forEach(function(d){
                        if (d.country == "gb" && d.datetime.substr(6, 4) == year){
                            sightings+=1;
                            myDataParsed.push(d);
                        }
                    })
                    
                    console.log(myDataParsed);
                //update the sightings count
                    displaySightings();

                //place markers for all filtered data elements using UFO icon
                    myDataParsed.forEach(function(d){
                        var markerText = "City" + d.city;
                        marker = L.marker([d.latitude, d.longitude], {icon: myIcon}).addTo(map)
                        .bindTooltip("<b>City: </b>"  + d.city.substring(0, d.city.indexOf("("))  + "<br><b>Type: </b>" + d.shape);
                        currentLayer = L.marker([d.latitude, d.longitude], {icon: myIcon});
                        markersLayer.addLayer(marker); 
                        markersLayer.addTo(map);
                    })
                })
            };
            
            function addYear() {
                year++;
                displayYear();
                console.log(year);
                reload();
            };
            
            function minusYear() {
                year--;
                displayYear();
                console.log(year);
                reload();
            };
            
            function displayYear() {
                document.getElementById("year").innerHTML = year;
            };
            
            displayYear();
            
            function displaySightings() {
                document.getElementById("sightings").innerHTML = "Sightings: " + sightings;
                console.log("sightings: " + sightings);
            };
            
		</script>
		
	</body>

</html>